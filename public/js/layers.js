L.GridLayer.Lidar=L.GridLayer.extend({createTile:function(t,o){var s=document.createElement("canvas"),e=this.getTileSize();s.setAttribute("width",e.x),s.setAttribute("height",e.y);var y=s.getContext("2d"),n=t.x,r=Math.abs(t.y)-1;return fetch("/lidar?lat="+n+"&lon="+r).then(function(t){return t.json()}).then(function(t){for(var e=t.data,n=0;n<e.length;n++)for(var r=e[n],a=0;a<r.length;a++){r[a]<0&&(r[a]=0);var i=r[a]/120;y.fillStyle="rgba(0,0,0,"+i+")",y.fillRect(a,n,1,1)}o(null,s)}).catch(function(t){console.log(t)}),s}}),L.gridLayer.lidar=function(t){return new L.GridLayer.Lidar(t)},map.addLayer(L.gridLayer.lidar());var SunPositionLayer=L.CanvasLayer.extend({render:function(){var t=this.getCanvas(),e=t.getContext("2d");e.clearRect(0,0,t.width,t.height);var n=getSunAzis(MAP_CENTER),a=this._map.latLngToContainerPoint(MAP_CENTER);e.fillStyle="rgba(255, 60, 60, 0.2)",e.strokeStyle="rgba(255, 60, 60, 0.9)",r=t.width;var i=a.x+r*Math.cos(Math.PI/2+n.sunrise),o=a.y+r*Math.sin(Math.PI/2+n.sunrise),s=a.x+r*Math.cos(Math.PI/2+n.sunset),y=a.y+r*Math.sin(Math.PI/2+n.sunset);e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(i,o),e.stroke(),e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(s,y),e.stroke();var u={startX:0,startY:t.height,endX:t.width,endY:t.height},c=computeIntersection({x:u.startX,y:u.startY},{x:u.endX,y:u.endY},{x:a.x,y:a.y},{x:i,y:o}),d=computeIntersection({x:u.startX,y:u.startY},{x:u.endX,y:u.endY},{x:a.x,y:a.y},{x:s,y:y}),h=new Image;h.onload=function(){e.drawImage(h,c.point.x-31,c.point.y-35,62,35)},h.src="../img/sunrise.svg";var x=new Image;x.onload=function(){e.drawImage(x,d.point.x-31,d.point.y-35,62,35)},x.src="../img/sunset.svg"}}),sunPositionLayer=new SunPositionLayer;function computeIntersection(t,e,n,r){var a=this.computeH(t,e,n,r),i=this.computeH(n,r,t,e),o=(isNaN(a)||isNaN(i),r.x-n.x),s=r.y-n.y;return{intersection:0<=a&&a<=1&&0<=i&&i<=1,point:{x:n.x+o*a,y:n.y+s*a}}}function computeH(t,e,n,r){var a={x:e.x-t.x,y:e.y-t.y},i=r.x-n.x,o=r.y-n.y,s=-a.y,y=a.x,u=i*s+o*y;return 0===u?NaN:((t.x-n.x)*s+(t.y-n.y)*y)/u}sunPositionLayer.addTo(map);