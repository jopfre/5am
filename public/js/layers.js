L.GridLayer.DebugCoords=L.GridLayer.extend({createTile:function(t){var e=document.createElement("div");return e.innerHTML=[t.x,t.y-1,t.z].join(", "),e}}),L.gridLayer.debugCoords=function(t){return new L.GridLayer.DebugCoords(t)},map.addLayer(L.gridLayer.debugCoords({tileSize:250})),L.GridLayer.Lidar=L.GridLayer.extend({createTile:function(t,o){var s=document.createElement("canvas"),e=this.getTileSize();s.setAttribute("width",e.x),s.setAttribute("height",e.y);var d=s.getContext("2d"),n=t.x,r=Math.abs(t.y)-1;return fetch("/lidar?lat="+n+"&lon="+r).then(parseJSON).then(function(t){if(!t.ok)throw Error(t.json.error);for(var e=t.json.data,n=0;n<e.length;n++)for(var r=e[n],i=0;i<r.length;i++){r[i]<0&&(r[i]=0);var a=r[i]/120;d.fillStyle="rgba(0,0,0,"+a+")",d.fillRect(i,n,1,1)}o(null,s)}).catch(function(t){console.log(t)}),s}}),L.gridLayer.lidar=function(t){return new L.GridLayer.Lidar(t)},map.addLayer(L.gridLayer.lidar({tileSize:250}));var SunPositionLayer=L.CanvasLayer.extend({render:function(){var t=this.getCanvas(),e=t.getContext("2d");e.clearRect(0,0,t.width,t.height);var n=getSunAzis(MAP_CENTER),r=this._map.latLngToContainerPoint(MAP_CENTER),i=t.width>t.height?t.width:t.height,a=r.x+i*Math.cos(Math.PI/2+n.sunrise),o=r.y+i*Math.sin(Math.PI/2+n.sunrise),s=r.x+i*Math.cos(Math.PI/2+n.sunset),d=r.y+i*Math.sin(Math.PI/2+n.sunset);e.strokeStyle="rgb(0, 70, 127)",e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(a,o),e.stroke(),e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(s,d),e.stroke();var y={startX:0,startY:t.height,endX:t.width,endY:t.height},u=computeIntersection({x:y.startX,y:y.startY},{x:y.endX,y:y.endY},{x:r.x,y:r.y},{x:a,y:o}),c=computeIntersection({x:y.startX,y:y.startY},{x:y.endX,y:y.endY},{x:r.x,y:r.y},{x:s,y:d});e.drawImage(document.getElementById("sunrise-icon"),u.point.x-31,u.point.y-35,62,35),e.drawImage(document.getElementById("sunset-icon"),c.point.x-31,c.point.y-35,62,35)}}),sunPositionLayer=new SunPositionLayer;function parseJSON(n){return new Promise(function(e){n.json().then(function(t){e({status:n.status,ok:n.ok,json:t})})})}function computeIntersection(t,e,n,r){var i=this.computeH(t,e,n,r),a=this.computeH(n,r,t,e),o=(isNaN(i)||isNaN(a),r.x-n.x),s=r.y-n.y;return{intersection:0<=i&&i<=1&&0<=a&&a<=1,point:{x:n.x+o*i,y:n.y+s*i}}}function computeH(t,e,n,r){var i={x:e.x-t.x,y:e.y-t.y},a=r.x-n.x,o=r.y-n.y,s=-i.y,d=i.x,y=a*s+o*d;return 0===y?NaN:((t.x-n.x)*s+(t.y-n.y)*d)/y}sunPositionLayer.addTo(map);